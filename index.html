<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø´Ù‚â€ŒÛŒØ§Ø± â€“ Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.css" rel="stylesheet">
  <style>
    /* ----- original styles (kept) + fixes for selects in dark mode ----- */
    :root{--primary:#4361ee;--primary-light:#4cc9f0;--dark:#03071e;--dark-card:#1d3557;--dark-border:rgba(255,255,255,.12);--light:#f8f9fa;--light-card:#fff;--light-border:rgba(0,0,0,.08);--text-dark:#212529;--text-light:#f8f9fa;--radius:16px;--shadow:0 4px 20px rgba(0,0,0,.15);--transition:all .3s ease}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Vazirmatn',sans-serif}
    body{background:linear-gradient(135deg,var(--dark) 0%,#3a0ca3 100%);color:var(--text-light);min-height:100vh;transition:var(--transition)}
    body.light-theme{background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);color:var(--text-dark)}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{padding:20px 0;position:sticky;top:0;z-index:100;background:rgba(3,7,30,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--dark-border)}
    body.light-theme header{background:rgba(255,255,255,.85);border-bottom:1px solid var(--light-border)}
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:15px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;color:#fff}
    .card{background:var(--dark-card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:20px}
    body.light-theme .card{background:var(--light-card)}
    .card-header{padding:20px;border-bottom:1px solid var(--dark-border);display:flex;justify-content:space-between;align-items:center}
    body.light-theme .card-header{border-bottom:1px solid var(--light-border)}
    .card-body{padding:20px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:8px}
    .form-control{width:100%;padding:10px;border-radius:10px;border:1px solid var(--dark-border);background:rgba(255,255,255,.04);color:var(--text-light)}
    body.light-theme .form-control{background:rgba(0,0,0,.02);color:var(--text-dark);border:1px solid var(--light-border)}
    .btn{padding:10px 14px;border-radius:12px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff}
    .btn-secondary{background:rgba(255,255,255,.06);color:var(--text-light)}
    body.light-theme .btn-secondary{background:rgba(0,0,0,.05);color:var(--text-dark)}
    .subjects-badges{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .subject-badge{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:20px;background:rgba(255,255,255,.06)}
    body.light-theme .subject-badge{background:rgba(0,0,0,.04)}
    .subject-color{width:14px;height:14px;border-radius:50%}
    .tasks-list{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .task-item{background:rgba(255,255,255,.04);padding:12px;border-radius:12px;display:grid;grid-template-columns:1fr auto;gap:12px}
    body.light-theme .task-item{background:rgba(0,0,0,.02)}
    .task-item.overdue{border-right:3px solid #ef476f}
    .task-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;background:rgba(255,255,255,.08)}
    body.light-theme .task-badge{background:rgba(0,0,0,.04)}
    .priority-high{background:rgba(239,71,111,.18);color:#ff8fab}
    .priority-low{background:rgba(76,201,240,.12);color:#a5d8ff}
    .filter-select{padding:8px 12px;border-radius:8px;border:1px solid var(--dark-border);background:rgba(255,255,255,.04);color:var(--text-light)}
    body.light-theme .filter-select{background:rgba(0,0,0,.02);color:var(--text-dark);border:1px solid var(--light-border)}
    /* select readability fixes */
    select.form-control, select.filter-select { color: var(--text-light); background: rgba(255,255,255,0.03); }
    body.light-theme select.form-control, body.light-theme select.filter-select { color: var(--text-dark); background: var(--light-card); }
    select.form-control option, select.filter-select option { color: inherit; background: transparent; }
    /* small helpers */
    .row{display:flex;gap:8px}
    @media (max-width:900px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">Ù…</div>
          <div>
            <h1>Ù…Ø´Ù‚â€ŒÛŒØ§Ø±</h1>
            <div class="tagline">ÛŒØ§Ø¯Ø¢ÙˆØ± ØªÚ©Ø§Ù„ÛŒÙ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</div>
          </div>
        </div>
        <div class="header-actions">
          <button id="btn-export" class="btn btn-secondary">Ø®Ø±ÙˆØ¬ÛŒ PNG</button>
          <button id="clearBtn" class="btn btn-danger">Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
          <button id="themeToggle" class="theme-toggle">ğŸŒ™</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="dashboard">
      <div class="card" style="min-width:320px">
        <div class="card-header">
          <div class="card-title"><div class="card-icon">ğŸ“š</div><span>Ø§ÙØ²ÙˆØ¯Ù† ØªÚ©Ù„ÛŒÙ Ø¬Ø¯ÛŒØ¯</span></div>
        </div>
        <div class="card-body">
          <form id="task-form">
            <div class="form-group">
              <label class="form-label">Ø¹Ù†ÙˆØ§Ù† ØªÚ©Ù„ÛŒÙ</label>
              <input type="text" id="title" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø­Ù„ ØªÙ…Ø±ÛŒÙ† ØµÙØ­Ù‡ Û´Û²" required>
            </div>

            <div class="form-group">
              <label class="form-label">Ø¯Ø±Ø³</label>
              <div class="subject-selector">
                <!-- original big select kept; we'll convert options to state on load -->
                <select id="subject" name="subject" class="form-control" required>
                  <option value="" disabled selected>ÛŒÚ© Ø¯Ø±Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†â€¦</option>
                  <optgroup label="ğŸŸ¢ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ (Ø¯Ø¨Ø³ØªØ§Ù†)">
                    <option value="ÙØ§Ø±Ø³ÛŒ (Ø®ÙˆØ§Ù†Ø¯Ø§Ø±ÛŒ + Ù†Ú¯Ø§Ø±Ø´)" data-color="#4361ee">ÙØ§Ø±Ø³ÛŒ (Ø®ÙˆØ§Ù†Ø¯Ø§Ø±ÛŒ + Ù†Ú¯Ø§Ø±Ø´)</option>
                    <option value="Ø±ÛŒØ§Ø¶ÛŒ" data-color="#3a0ca3">Ø±ÛŒØ§Ø¶ÛŒ</option>
                    <option value="Ø¹Ù„ÙˆÙ… ØªØ¬Ø±Ø¨ÛŒ" data-color="#f72585">Ø¹Ù„ÙˆÙ… ØªØ¬Ø±Ø¨ÛŒ</option>
                    <option value="Ù…Ø·Ø§Ù„Ø¹Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ" data-color="#4cc9f0">Ù…Ø·Ø§Ù„Ø¹Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</option>
                    <option value="Ù‚Ø±Ø¢Ù†" data-color="#f8961e">Ù‚Ø±Ø¢Ù†</option>
                  </optgroup>
                  <optgroup label="ğŸ”µ Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„ (Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ)">
                    <option value="ÙØ§Ø±Ø³ÛŒ (Ø§Ø¯Ø¨ÛŒØ§Øª + Ù†Ú¯Ø§Ø±Ø´)" data-color="#4361ee">ÙØ§Ø±Ø³ÛŒ (Ø§Ø¯Ø¨ÛŒØ§Øª + Ù†Ú¯Ø§Ø±Ø´)</option>
                    <option value="Ø±ÛŒØ§Ø¶ÛŒ" data-color="#3a0ca3">Ø±ÛŒØ§Ø¶ÛŒ</option>
                    <option value="Ø¹Ù„ÙˆÙ… ØªØ¬Ø±Ø¨ÛŒ" data-color="#f72585">Ø¹Ù„ÙˆÙ… ØªØ¬Ø±Ø¨ÛŒ</option>
                    <option value="Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ" data-color="#43aa8b">Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</option>
                  </optgroup>
                  <optgroup label="ğŸŸ£ Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ… (Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù†)">
                    <option value="Ø­Ø³Ø§Ø¨Ø§Ù†" data-color="#4361ee">Ø­Ø³Ø§Ø¨Ø§Ù†</option>
                    <option value="Ù‡Ù†Ø¯Ø³Ù‡" data-color="#3a0ca3">Ù‡Ù†Ø¯Ø³Ù‡</option>
                    <option value="ÙÛŒØ²ÛŒÚ©" data-color="#f8961e">ÙÛŒØ²ÛŒÚ©</option>
                    <option value="Ø´ÛŒÙ…ÛŒ" data-color="#f94144">Ø´ÛŒÙ…ÛŒ</option>
                  </optgroup>
                </select>

                <!-- add-subject controls -->
                <div class="row" style="margin-top:10px;align-items:center">
                  <input id="newSubjectName" class="form-control" placeholder="Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯..." style="flex:1">
                  <input id="newSubjectColor" type="color" value="#4361ee" style="width:56px;height:40px;border-radius:8px;border:none">
                  <button type="button" id="addSubjectBtn" class="btn btn-secondary">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
              </div>
            </div>

            <div id="subjectsBadges" class="subjects-badges"></div>

            <div class="deadline-section">
              <div class="deadline-header">
                <label class="form-label">Ù…Ù‡Ù„Øª ØªØ­ÙˆÛŒÙ„</label>
                <div class="deadline-toggle" style="margin-right:auto;display:flex;align-items:center;gap:8px">
                  <span>ÙØ¹Ø§Ù„ Ø´ÙˆØ¯ØŸ</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="deadline-enabled">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div id="deadline-fields" style="display:none">
                <div class="form-group">
                  <label class="form-label">ØªØ§Ø±ÛŒØ® Ù…Ù‡Ù„Øª</label>
                  <input id="deadline-date" class="form-control" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)" autocomplete="off">
                </div>
                <div class="form-group">
                  <label class="form-label">Ø³Ø§Ø¹Øª Ù…Ù‡Ù„Øª</label>
                  <input id="deadline-time" type="time" class="form-control" value="18:00">
                </div>
              </div>
            </div>

            <div class="form-row-3">
              <div class="form-group">
                <label class="form-label">Ø§ÙˆÙ„ÙˆÛŒØª</label>
                <select id="taskPriority" class="form-control">
                  <option value="normal">Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
                  <option value="high">Ø¨Ø§Ù„Ø§</option>
                  <option value="low">Ú©Ù…</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">ÙˆØ¶Ø¹ÛŒØª</label>
                <select id="taskStatus" class="form-control">
                  <option value="open">Ø¨Ø§Ø²</option>
                  <option value="done">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</label>
                <input type="text" id="taskMembers" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒØŒ Ø³Ø§Ø±Ø§">
              </div>
            </div>

            <details id="optional-box">
              <summary>Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ</summary>
              <div class="form-group">
                <label for="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ (Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ù…ÙˆØ¹Ø¯)</label>
                <input id="reminder" type="number" min="0" step="5" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹ 15">
              </div>
              <div class="form-group">
                <label for="notes">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                <textarea id="notes" rows="3" class="form-control"></textarea>
              </div>
            </details>

            <div class="form-group">
              <button type="submit" id="addTaskBtn" class="btn btn-primary" style="width:100%">Ø«Ø¨Øª ØªÚ©Ù„ÛŒÙ</button>
            </div>
          </form>

          <div class="stats-container">
            <div class="stat-card"><div class="stat-label">ØªÚ©Ø§Ù„ÛŒÙ Ø¨Ø§Ø²</div><div id="kpiOpen" class="stat-value">0</div></div>
            <div class="stat-card"><div class="stat-label">ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡</div><div id="kpiDone" class="stat-value">0</div></div>
            <div class="stat-card"><div class="stat-label">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù…ÙˆØ¹Ø¯</div><div id="kpiNext" class="stat-value">â€”</div></div>
          </div>
        </div>
      </div>

      <div class="card" id="board">
        <div class="card-header"><div class="card-title"><div class="card-icon">ğŸ“</div><span>ØªÚ©Ø§Ù„ÛŒÙ Ù…Ù†</span></div></div>
        <div class="card-body">
          <div class="tasks-header" style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <div style="flex:1;min-width:180px"><input id="searchBox" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÚ©Ø§Ù„ÛŒÙ..."></div>
            <div class="filters" style="display:flex;gap:8px;align-items:center">
              <select id="filterSubject" class="filter-select"><option value="">Ù‡Ù…Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§</option></select>
              <select id="filterStatus" class="filter-select"><option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option><option value="open">Ø¨Ø§Ø²</option><option value="done">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</option><option value="overdue">Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡</option></select>
              <select id="sortBy" class="filter-select"><option value="dueAsc">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù…ÙˆØ¹Ø¯</option><option value="dueDesc">Ø¯ÙˆØ±ØªØ±ÛŒÙ† Ù…ÙˆØ¹Ø¯</option><option value="prio">Ø§ÙˆÙ„ÙˆÛŒØª</option><option value="created">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</option></select>
            </div>
          </div>

          <div id="tasksList" class="tasks-list"></div>
          <div id="emptyState" class="empty-state" style="display:none;text-align:center;padding:30px;opacity:.8"> <div class="empty-icon">ğŸ“­</div><h3>Ù‡Ù†ÙˆØ² ØªÚ©Ù„ÛŒÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3><p>Ø§Ø² ÙØ±Ù… Ø³Ù…Øª Ú†Ù¾ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† âœï¸</p></div>
        </div>
      </div>
    </div>

    <div class="footer">Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† â€” Ù†Ø³Ø®Ù‡Ù” Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ù…Ø­Ù„ÛŒ (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</div>
  </main>

  <div class="notification" id="notification" style="right:20px;left:auto;bottom:20px;position:fixed;display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:10px;background:var(--dark-card);color:var(--text-light);transform:translateY(100px);opacity:0;transition:var(--transition);z-index:2000">
    <span class="notification-icon">âœ“</span>
    <span class="notification-message">Ù¾ÛŒØºØ§Ù…</span>
    <button class="notification-close" style="margin-inline-start:auto;background:none;border:none;color:inherit;font-size:18px;cursor:pointer">Ã—</button>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // keep $ as jQuery â€” we will use it throughout
    // small vanilla helpers (don't override $)
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // storage
    const storeKey = 'mashqyar:v1';
    const remindersKey = 'mashqyar.reminders.v1';

    function uid(){ return 'id_'+Math.random().toString(36).slice(2,10); }
    function loadData(){ try{ const raw = localStorage.getItem(storeKey); if(!raw) return {subjects:[],tasks:[]}; const d = JSON.parse(raw); d.subjects = d.subjects||[]; d.tasks = d.tasks||[]; return d;}catch(e){console.error(e); return {subjects:[],tasks:[]}; }}
    function saveData(d){ localStorage.setItem(storeKey, JSON.stringify(d)); }

    function showNotification(msg, duration=2500){ const n = $('#notification'); $('.notification-message').text(msg); n.addClass('show'); n.css({transform:'translateY(0)',opacity:1}); setTimeout(()=>{ n.removeClass('show'); n.css({transform:'translateY(100px)',opacity:0}); }, duration); }
    $('.notification-close').on('click', ()=>{ $('#notification').removeClass('show'); $('#notification').css({transform:'translateY(100px)',opacity:0}); });

    let state = loadData();

    // --- import existing options into state.subjects if empty
    function importSubjectsFromSelectIfNeeded(){
      if (state.subjects && state.subjects.length) return;
      const seen = new Map();
      $('#subject').find('option').each(function(){
        const opt = $(this);
        if (opt.prop('disabled')) return; // skip placeholder and disabled
        const name = opt.text().trim();
        if (!name) return;
        if (seen.has(name)) return;
        const color = opt.data('color') || '#4361ee';
        const id = uid();
        seen.set(name, { id, name, color });
        // replace option value with id so future selections yield id
        opt.val(id);
      });
      state.subjects = Array.from(seen.values());
      saveData(state);
    }

    // render badges & filter
    function renderSubjectsBadges(){ $('#subjectsBadges').empty(); state.subjects.forEach(s=>{
      const $span = $(`<span class="subject-badge" data-id="${s.id}"><span class="subject-color" style="background:${s.color}"></span><span class="subject-name">${s.name}</span><button class="del-subject" title="Ø­Ø°Ù Ø¯Ø±Ø³" style="margin-inline-start:8px;border:none;background:transparent;color:inherit;cursor:pointer">âœ–</button></span>`);
      $('#subjectsBadges').append($span);
      $span.find('.del-subject').on('click', function(e){ e.stopPropagation(); if(!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø±Ø³ Ùˆ ØªÙ…Ø§Ù… ØªÚ©Ø§Ù„ÛŒÙ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return; const id = s.id; state.tasks = state.tasks.filter(t=>t.subjectId!==id); state.subjects = state.subjects.filter(x=>x.id!==id); // also remove any <option> with this id
        $('#subject').find(`option[value="${id}"]`).remove(); updateSubjectFilter(); saveData(state); renderSubjectsBadges(); renderTasks(); showNotification('Ø¯Ø±Ø³ Ùˆ ØªÚ©Ø§Ù„ÛŒÙ Ù…Ø±ØªØ¨Ø· Ø­Ø°Ù Ø´Ø¯'); });
    }); }

    function updateSubjectFilter(){ const $f = $('#filterSubject'); $f.empty().append('<option value="">Ù‡Ù…Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§</option>'); state.subjects.forEach(s=>{ $f.append($('<option>').val(s.id).text(s.name)); }); }

    function updateSubjectSelectFromState(){
      // ensure select has options for all state.subjects (and remove duplicates)
      const $sel = $('#subject');
      // remove all non-placeholder options
      $sel.find('option').each(function(){ const opt=$(this); if (opt.prop('disabled')) return; opt.remove(); });
      // append current subjects grouped by nothing (simple list) â€” preserves order of state
      state.subjects.forEach(s=>{ $sel.append($('<option>').val(s.id).text(s.name).attr('data-color', s.color)); });
      // keep placeholder at top
      $sel.prepend($('<option disabled selected value="">ÛŒÚ© Ø¯Ø±Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†â€¦</option>'));
    }

    // --- tasks UI
    function toPersianDate(dt){ if(!dt) return 'â€”'; try{ return new persianDate(new Date(dt)).format('YYYY/MM/DD'); }catch(e){return 'â€”'} }
    function toPersianDateTime(dt){ if(!dt) return 'â€”'; try{ return new persianDate(new Date(dt)).format('YYYY/MM/DD HH:mm'); }catch(e){return 'â€”'} }

    function priorityBadge(p){ if(p==='high') return '<span class="task-badge priority-high">Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§</span>'; if(p==='low') return '<span class="task-badge priority-low">Ø§ÙˆÙ„ÙˆÛŒØª Ú©Ù…</span>'; return '<span class="task-badge">Ù…Ø¹Ù…ÙˆÙ„ÛŒ</span>'; }

    function renderKPIs(){ const tasks = state.tasks || []; $('#kpiOpen').text(tasks.filter(t=>!t.completed).length); $('#kpiDone').text(tasks.filter(t=>t.completed).length); const upcoming = tasks.filter(t=>!t.completed&&t.deadline).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline))[0]; $('#kpiNext').text(upcoming? toPersianDate(upcoming.deadline) : 'â€”'); }

    function applyFilters(tasks){ let out = tasks.slice(); const q = $('#searchBox').val().trim().toLowerCase(); const subj = $('#filterSubject').val(); const status = $('#filterStatus').val(); if(q) out = out.filter(t => (t.title+' '+(t.notes||'')+' '+(t.members||'')).toLowerCase().includes(q)); if(subj) out = out.filter(t=>t.subjectId===subj); const now = Date.now(); if(status==='open') out=out.filter(t=>!t.completed); if(status==='done') out=out.filter(t=>t.completed); if(status==='overdue') out=out.filter(t=>!t.completed && t.deadline && new Date(t.deadline).getTime()<now); const sortBy = $('#sortBy').val(); if(sortBy==='dueAsc') out.sort((a,b)=> (new Date(a.deadline||'2100-01-01')-new Date(b.deadline||'2100-01-01'))); if(sortBy==='dueDesc') out.sort((a,b)=> (new Date(b.deadline||'1970-01-01')-new Date(a.deadline||'1970-01-01'))); if(sortBy==='prio'){ const rank={high:0,normal:1,low:2}; out.sort((a,b)=> (rank[a.priority||'normal']-rank[b.priority||'normal']) || (new Date(a.deadline||'2100-01-01')-new Date(b.deadline||'2100-01-01'))); } if(sortBy==='created') out.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)); return out; }

    function subjectById(id){ return state.subjects.find(s=>s.id===id); }

    function renderTasks(){ const $container = $('#tasksList'); const tasks = applyFilters(state.tasks || []); renderKPIs(); $container.empty(); if(!tasks.length){ $('#emptyState').show(); return; } $('#emptyState').hide(); tasks.forEach(t=>{ const s = subjectById(t.subjectId); const deadline = t.deadline? new Date(t.deadline) : null; const overdue = !t.completed && deadline && deadline.getTime() < Date.now(); const $div = $('<div>').addClass('task-item' + (overdue? ' overdue':'')); const $content = $('<div>').addClass('task-content'); const $title = $('<h3>').text(t.title); $content.append($title); const $meta = $('<div>').addClass('task-meta'); if(s){ $meta.append($(`<span class="task-badge"><span class="subject-color" style="background:${s.color}"></span>${s.name}</span>`)); } if(t.deadline){ $meta.append($('<span>').addClass('task-badge').text('Ù…Ù‡Ù„Øª: '+ toPersianDateTime(t.deadline))); } $meta.append($(priorityBadge(t.priority||'normal'))); if(t.members){ $meta.append($('<span>').addClass('task-badge').text('Ø§Ø¹Ø¶Ø§: '+t.members)); } $content.append($meta); if(t.notes){ $content.append($('<div>').addClass('task-description').text(t.notes)); } const $actions = $('<div>').addClass('task-actions'); const $done = $('<button>').addClass('task-btn complete').html(t.completed? 'â†©ï¸' : 'âœ“').attr('title', t.completed? 'Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù† Ø¨Ù‡ Ø¨Ø§Ø²' : 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯').on('click', ()=>{ t.completed = !t.completed; saveData(state); renderTasks(); showNotification(t.completed? 'ØªÚ©Ù„ÛŒÙ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯' : 'ØªÚ©Ù„ÛŒÙ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¨Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª',2000); }); const $edit = $('<button>').addClass('task-btn').html('âœï¸').attr('title','ÙˆÛŒØ±Ø§ÛŒØ´').on('click', ()=> editTask(t.id)); const $del = $('<button>').addClass('task-btn').html('ğŸ—‘ï¸').attr('title','Ø­Ø°Ù').on('click', ()=>{ if(confirm('Ø§ÛŒÙ† ØªÚ©Ù„ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){ state.tasks = state.tasks.filter(x=>x.id!==t.id); saveData(state); renderTasks(); showNotification('ØªÚ©Ù„ÛŒÙ Ø­Ø°Ù Ø´Ø¯',2000); } }); $actions.append($done,$edit,$del); $div.append($content,$actions); $container.append($div); }); }

    // --- editTask
    function editTask(id){ const t = state.tasks.find(x=>x.id===id); if(!t) return; const subj = subjectById(t.subjectId); if(subj){ $('#subject').val(subj.id); } if(t.deadline){ $('#deadline-enabled').prop('checked', true); $('#deadline-fields').show(); const date = new persianDate(new Date(t.deadline)); $('#deadline-date').val(date.format('YYYY/MM/DD')); const time = new Date(t.deadline); $('#deadline-time').val(time.toTimeString().slice(0,5)); } else { $('#deadline-enabled').prop('checked', false); $('#deadline-fields').hide(); } $('#taskPriority').val(t.priority||'normal'); $('#taskStatus').val(t.completed? 'done' : 'open'); $('#taskMembers').val(t.members||''); if(t.remindMinutes || t.notes){ $('#optional-box').prop('open', true); $('#reminder').val(t.remindMinutes||''); $('#notes').val(t.notes||''); } $('#addTaskBtn').text('Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª').data('editId', id); window.scrollTo({top:0,behavior:'smooth'}); }

    // --- update filters
    function updateSubjectFilter(){ const $f = $('#filterSubject'); $f.empty().append('<option value="">Ù‡Ù…Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§</option>'); state.subjects.forEach(s=>{ $f.append($('<option>').val(s.id).text(s.name)); }); }

    // --- initial import & seed
    importSubjectsFromSelectIfNeeded(); updateSubjectFilter(); renderSubjectsBadges(); renderTasks(); updateSubjectSelectFromState(); // ensure #subject now uses ids as values

    // add-subject button
    $('#addSubjectBtn').on('click', function(){ const name = $('#newSubjectName').val().trim(); const color = $('#newSubjectColor').val() || '#4361ee'; if(!name){ showNotification('Ù†Ø§Ù… Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯',2000); return; } if(state.subjects.find(s=>s.name===name)){ showNotification('Ø§ÛŒÙ† Ø¯Ø±Ø³ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯',2000); return; } const s = { id: uid(), name, color }; state.subjects.push(s); saveData(state); renderSubjectsBadges(); updateSubjectFilter(); updateSubjectSelectFromState(); $('#newSubjectName').val(''); showNotification('Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯',2000); });

    // toggle deadline fields
    function toggleDeadlineUI(){ const enabled = $('#deadline-enabled').is(':checked'); if(enabled) $('#deadline-fields').show(); else $('#deadline-fields').hide(); }
    $('#deadline-enabled').on('change', toggleDeadlineUI); toggleDeadlineUI();

    // bind filters
    ['#searchBox','#filterSubject','#filterStatus','#sortBy'].forEach(sel=>{ $(sel).on('input change', renderTasks); });

    // form submit (with scheduling reminders)
    $('#task-form').on('submit', function(e){ e.preventDefault(); const title = $('#title').val().trim(); const subjectId = $('#subject').val(); const subjectOption = $('#subject').find('option:selected'); const subjectColor = subjectOption.data('color') || '#4361ee'; // find or create subject
      let subject = state.subjects.find(s=>s.id===subjectId);
      if(!subject && $('#subject').val()){ // maybe option existed but not in state (rare)
        // create
        subject = { id: subjectId || uid(), name: subjectOption.text().trim(), color: subjectColor };
        state.subjects.push(subject);
        saveData(state); renderSubjectsBadges(); updateSubjectFilter(); updateSubjectSelectFromState();
      }
      let deadline = null; if($('#deadline-enabled').is(':checked')){ const dateStr = $('#deadline-date').val(); const timeStr = $('#deadline-time').val(); if(dateStr){ const pd = new persianDate(dateStr); const gDate = pd.toCalendar('gregorian').toDate(); if(timeStr){ const parts = timeStr.split(':'); gDate.setHours(parseInt(parts[0]||0,10), parseInt(parts[1]||0,10), 0,0); } deadline = gDate.toISOString(); } }
      const priority = $('#taskPriority').val() || 'normal'; const status = $('#taskStatus').val()==='done'; const members = $('#taskMembers').val().trim(); const remindMinutes = parseInt($('#reminder').val()||'0',10) || 0; const notes = $('#notes').val().trim(); if(!title){ showNotification('Ø¹Ù†ÙˆØ§Ù† ØªÚ©Ù„ÛŒÙ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯',2000); return; } if(!subject){ showNotification('Ø¯Ø±Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',2000); return; }
      const editId = $('#addTaskBtn').data('editId'); if(editId){ const t = state.tasks.find(x=>x.id===editId); if(t){ t.title = title; t.subjectId = subject.id; t.deadline = deadline; t.priority = priority; t.completed = status; t.members = members; t.remindMinutes = remindMinutes; t.notes = notes; } $('#addTaskBtn').text('Ø«Ø¨Øª ØªÚ©Ù„ÛŒÙ').removeData('editId'); showNotification('ØªÚ©Ù„ÛŒÙ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯',2000); // update reminders: remove any existing reminder for this id
        const rems = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const idx = rems.findIndex(r=>r.id===editId); if(idx>-1) rems.splice(idx,1); localStorage.setItem(remindersKey, JSON.stringify(rems));
        // schedule new reminder if needed below
      } else {
        const newId = uid(); state.tasks.push({ id:newId, title, subjectId:subject.id, deadline, priority, completed:status, members, remindMinutes, notes, createdAt: new Date().toISOString() }); // schedule reminder using newId
        if(remindMinutes>0 && deadline){ scheduleReminder({ id: newId, title, subject: subject.name, deadlineTs: new Date(deadline).getTime(), reminderMin: remindMinutes }); }
        showNotification('ØªÚ©Ù„ÛŒÙ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯',2000);
      }
      // if editing and reminder requested, schedule
      if(editId){ if(remindMinutes>0 && deadline){ scheduleReminder({ id: editId, title, subject: subject.name, deadlineTs: new Date(deadline).getTime(), reminderMin: remindMinutes }); } }
      saveData(state); this.reset(); $('#deadline-fields').hide(); $('#optional-box').prop('open', false); updateSubjectFilter(); renderSubjectsBadges(); renderTasks(); });

    // clear all
    $('#clearBtn').on('click', function(){ if(confirm('Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){ localStorage.removeItem(storeKey); localStorage.removeItem(remindersKey); state = { subjects: [], tasks: [] }; // re-import options from original select DOM (if any)
        importSubjectsFromSelectIfNeeded(); updateSubjectFilter(); renderSubjectsBadges(); renderTasks(); showNotification('ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯',2000); } });

    // export PNG
    $('#btn-export').on('click', async function(){ try{ const canvas = await html2canvas(document.getElementById('board'), { useCORS:true, scale:2 }); const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = 'mashqyar.png'; document.body.appendChild(a); a.click(); a.remove(); showNotification('Ø®Ø±ÙˆØ¬ÛŒ PNG Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯',2000); }catch(e){ console.error(e); showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø±ÙˆØ¬ÛŒ PNG',2000); } });

    // persian datepicker init
    $('#deadline-date').persianDatepicker({ initialValue:false, format:'YYYY/MM/DD', autoClose:true });

    // ===== reminders scheduling & rebuild =====
    function scheduleReminder({id, title, subject, deadlineTs, reminderMin}){
      if(!deadlineTs || !reminderMin || reminderMin<=0) return;
      const fireAt = deadlineTs - reminderMin*60*1000;
      if(isNaN(fireAt) || fireAt <= Date.now()) return;
      const list = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const exists = list.find(x=>x.id===id);
      const payload = { id, title, subject, fireAt, shown:false };
      if(!exists) list.push(payload); else Object.assign(exists, payload);
      localStorage.setItem(remindersKey, JSON.stringify(list));
      const delay = fireAt - Date.now(); setTimeout(()=> showReminder(id,title,subject), delay);
    }
    function showReminder(id,title,subject){ try{ new Notification('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ØªÚ©Ù„ÛŒÙ', { body: subject? `${title} â€” ${subject}`:title }); }catch(e){} const list = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const it = list.find(x=>x.id===id); if(it){ it.shown = true; localStorage.setItem(remindersKey, JSON.stringify(list)); } }
    window.__mashqyar__showReminder = showReminder;

    async function ensurePermission(){ if(!('Notification' in window)) return false; if(Notification.permission==='granted') return true; if(Notification.permission==='denied') return false; const p = await Notification.requestPermission(); return p==='granted'; }

    // When form submit schedules reminders for new tasks (see submit handler). Also rebuild on load:
    (function rebuildReminders(){ if(!('Notification' in window)) return; const list = JSON.parse(localStorage.getItem(remindersKey)||'[]'); list.forEach(it=>{ if(it.shown) return; const delay = it.fireAt - Date.now(); if(delay<=0){ try{ new Notification('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ØªÚ©Ù„ÛŒÙ', { body: it.subject? `${it.title} â€” ${it.subject}`:it.title }); }catch(e){} it.shown = true; } else { setTimeout(()=>{ try{ new Notification('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ØªÚ©Ù„ÛŒÙ', { body: it.subject? `${it.title} â€” ${it.subject}`:it.title }); }catch(e){} it.shown = true; const cur = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const me = cur.find(x=>x.id===it.id); if(me) me.shown = true; localStorage.setItem(remindersKey, JSON.stringify(cur)); }, delay); } }); localStorage.setItem(remindersKey, JSON.stringify(list)); })();

    // When page loads, if no subjects in state, import from select (already called above) and if tasks empty create sample tasks using subjects (optional)
    if((!state.subjects || state.subjects.length===0) && $('#subject').find('option').length>1){ importSubjectsFromSelectIfNeeded(); updateSubjectFilter(); renderSubjectsBadges(); updateSubjectSelectFromState(); saveData(state); }
    if(!state.tasks || state.tasks.length===0){ // optional sample tasks â€” keep or remove as you like
      if(state.subjects && state.subjects.length>=2){ const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1); const dayAfter = new Date(); dayAfter.setDate(dayAfter.getDate()+2); state.tasks = [ { id: uid(), title: 'Ø­Ù„ ØªÙ…Ø±ÛŒÙ† 1 ØªØ§ 10', subjectId: state.subjects[0].id, deadline: tomorrow.toISOString(), remindMinutes: 120, priority: 'high', members:'', notes:'Ø¯ÙØªØ± Ø­Ù„ Ù„Ø§Ø²Ù… Ø§Ø³Øª', completed:false, createdAt:new Date().toISOString() }, { id: uid(), title: 'Ø®Ù„Ø§ØµÙ‡â€ŒÙ†ÙˆÛŒØ³ÛŒ ÙØµÙ„ Ú¯ÛŒØ§Ù‡Ø§Ù†', subjectId: state.subjects[1].id, deadline: dayAfter.toISOString(), remindMinutes: 60, priority: 'normal', members:'Ø¹Ù„ÛŒØŒ Ø²Ù‡Ø±Ø§', notes:'Ø¨Ø§ ØªØµØ§ÙˆÛŒØ±', completed:false, createdAt:new Date().toISOString() } ]; saveData(state); renderTasks(); }
    }

  </script>
</body>
</html>
