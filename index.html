<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مشق‌یار – نسخه اصلاح‌شده</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.css" rel="stylesheet">
  <style>
    /* ----- original styles (kept) + fixes for selects in dark mode ----- */
    :root{--primary:#4361ee;--primary-light:#4cc9f0;--dark:#03071e;--dark-card:#1d3557;--dark-border:rgba(255,255,255,.12);--light:#f8f9fa;--light-card:#fff;--light-border:rgba(0,0,0,.08);--text-dark:#212529;--text-light:#f8f9fa;--radius:16px;--shadow:0 4px 20px rgba(0,0,0,.15);--transition:all .3s ease}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Vazirmatn',sans-serif}
    body{background:linear-gradient(135deg,var(--dark) 0%,#3a0ca3 100%);color:var(--text-light);min-height:100vh;transition:var(--transition)}
    body.light-theme{background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);color:var(--text-dark)}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{padding:20px 0;position:sticky;top:0;z-index:100;background:rgba(3,7,30,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--dark-border)}
    body.light-theme header{background:rgba(255,255,255,.85);border-bottom:1px solid var(--light-border)}
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:15px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;color:#fff}
    .card{background:var(--dark-card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:20px}
    body.light-theme .card{background:var(--light-card)}
    .card-header{padding:20px;border-bottom:1px solid var(--dark-border);display:flex;justify-content:space-between;align-items:center}
    body.light-theme .card-header{border-bottom:1px solid var(--light-border)}
    .card-body{padding:20px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:8px}
    .form-control{width:100%;padding:10px;border-radius:10px;border:1px solid var(--dark-border);background:rgba(255,255,255,.04);color:var(--text-light)}
    body.light-theme .form-control{background:rgba(0,0,0,.02);color:var(--text-dark);border:1px solid var(--light-border)}
    .btn{padding:10px 14px;border-radius:12px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff}
    .btn-secondary{background:rgba(255,255,255,.06);color:var(--text-light)}
    body.light-theme .btn-secondary{background:rgba(0,0,0,.05);color:var(--text-dark)}
    .subjects-badges{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .subject-badge{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:20px;background:rgba(255,255,255,.06)}
    body.light-theme .subject-badge{background:rgba(0,0,0,.04)}
    .subject-color{width:14px;height:14px;border-radius:50%}
    .tasks-list{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .task-item{background:rgba(255,255,255,.04);padding:12px;border-radius:12px;display:grid;grid-template-columns:1fr auto;gap:12px}
    body.light-theme .task-item{background:rgba(0,0,0,.02)}
    .task-item.overdue{border-right:3px solid #ef476f}
    .task-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;background:rgba(255,255,255,.08)}
    body.light-theme .task-badge{background:rgba(0,0,0,.04)}
    .priority-high{background:rgba(239,71,111,.18);color:#ff8fab}
    .priority-low{background:rgba(76,201,240,.12);color:#a5d8ff}
    .filter-select{padding:8px 12px;border-radius:8px;border:1px solid var(--dark-border);background:rgba(255,255,255,.04);color:var(--text-light)}
    body.light-theme .filter-select{background:rgba(0,0,0,.02);color:var(--text-dark);border:1px solid var(--light-border)}
    /* select readability fixes */
    select.form-control, select.filter-select { color: var(--text-light); background: rgba(255,255,255,0.03); }
    body.light-theme select.form-control, body.light-theme select.filter-select { color: var(--text-dark); background: var(--light-card); }
    select.form-control option, select.filter-select option { color: inherit; background: transparent; }
    /* small helpers */
    .row{display:flex;gap:8px}
    @media (max-width:900px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">م</div>
          <div>
            <h1>مشق‌یار</h1>
            <div class="tagline">یادآور تکالیف دانش‌آموزی</div>
          </div>
        </div>
        <div class="header-actions">
          <button id="btn-export" class="btn btn-secondary">خروجی PNG</button>
          <button id="clearBtn" class="btn btn-danger">حذف داده‌ها</button>
          <button id="themeToggle" class="theme-toggle">🌙</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="dashboard">
      <div class="card" style="min-width:320px">
        <div class="card-header">
          <div class="card-title"><div class="card-icon">📚</div><span>افزودن تکلیف جدید</span></div>
        </div>
        <div class="card-body">
          <form id="task-form">
            <div class="form-group">
              <label class="form-label">عنوان تکلیف</label>
              <input type="text" id="title" class="form-control" placeholder="مثلاً حل تمرین صفحه ۴۲" required>
            </div>

            <div class="form-group">
              <label class="form-label">درس</label>
              <div class="subject-selector">
                <!-- original big select kept; we'll convert options to state on load -->
                <select id="subject" name="subject" class="form-control" required>
                  <option value="" disabled selected>یک درس را انتخاب کن…</option>
                  <optgroup label="🟢 ابتدایی (دبستان)">
                    <option value="فارسی (خوانداری + نگارش)" data-color="#4361ee">فارسی (خوانداری + نگارش)</option>
                    <option value="ریاضی" data-color="#3a0ca3">ریاضی</option>
                    <option value="علوم تجربی" data-color="#f72585">علوم تجربی</option>
                    <option value="مطالعات اجتماعی" data-color="#4cc9f0">مطالعات اجتماعی</option>
                    <option value="قرآن" data-color="#f8961e">قرآن</option>
                  </optgroup>
                  <optgroup label="🔵 متوسطه اول (راهنمایی)">
                    <option value="فارسی (ادبیات + نگارش)" data-color="#4361ee">فارسی (ادبیات + نگارش)</option>
                    <option value="ریاضی" data-color="#3a0ca3">ریاضی</option>
                    <option value="علوم تجربی" data-color="#f72585">علوم تجربی</option>
                    <option value="زبان انگلیسی" data-color="#43aa8b">زبان انگلیسی</option>
                  </optgroup>
                  <optgroup label="🟣 متوسطه دوم (دبیرستان)">
                    <option value="حسابان" data-color="#4361ee">حسابان</option>
                    <option value="هندسه" data-color="#3a0ca3">هندسه</option>
                    <option value="فیزیک" data-color="#f8961e">فیزیک</option>
                    <option value="شیمی" data-color="#f94144">شیمی</option>
                  </optgroup>
                </select>

                <!-- add-subject controls -->
                <div class="row" style="margin-top:10px;align-items:center">
                  <input id="newSubjectName" class="form-control" placeholder="افزودن درس جدید..." style="flex:1">
                  <input id="newSubjectColor" type="color" value="#4361ee" style="width:56px;height:40px;border-radius:8px;border:none">
                  <button type="button" id="addSubjectBtn" class="btn btn-secondary">افزودن</button>
                </div>
              </div>
            </div>

            <div id="subjectsBadges" class="subjects-badges"></div>

            <div class="deadline-section">
              <div class="deadline-header">
                <label class="form-label">مهلت تحویل</label>
                <div class="deadline-toggle" style="margin-right:auto;display:flex;align-items:center;gap:8px">
                  <span>فعال شود؟</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="deadline-enabled">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div id="deadline-fields" style="display:none">
                <div class="form-group">
                  <label class="form-label">تاریخ مهلت</label>
                  <input id="deadline-date" class="form-control" placeholder="انتخاب تاریخ (شمسی)" autocomplete="off">
                </div>
                <div class="form-group">
                  <label class="form-label">ساعت مهلت</label>
                  <input id="deadline-time" type="time" class="form-control" value="18:00">
                </div>
              </div>
            </div>

            <div class="form-row-3">
              <div class="form-group">
                <label class="form-label">اولویت</label>
                <select id="taskPriority" class="form-control">
                  <option value="normal">معمولی</option>
                  <option value="high">بالا</option>
                  <option value="low">کم</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">وضعیت</label>
                <select id="taskStatus" class="form-control">
                  <option value="open">باز</option>
                  <option value="done">انجام‌شده</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">اعضای گروه</label>
                <input type="text" id="taskMembers" class="form-control" placeholder="مثلاً: علی، سارا">
              </div>
            </div>

            <details id="optional-box">
              <summary>گزینه‌های اختیاری</summary>
              <div class="form-group">
                <label for="reminder">یادآوری (دقیقه قبل از موعد)</label>
                <input id="reminder" type="number" min="0" step="5" class="form-control" placeholder="مثلاً 15">
              </div>
              <div class="form-group">
                <label for="notes">توضیحات</label>
                <textarea id="notes" rows="3" class="form-control"></textarea>
              </div>
            </details>

            <div class="form-group">
              <button type="submit" id="addTaskBtn" class="btn btn-primary" style="width:100%">ثبت تکلیف</button>
            </div>
          </form>

          <div class="stats-container">
            <div class="stat-card"><div class="stat-label">تکالیف باز</div><div id="kpiOpen" class="stat-value">0</div></div>
            <div class="stat-card"><div class="stat-label">تکمیل‌شده</div><div id="kpiDone" class="stat-value">0</div></div>
            <div class="stat-card"><div class="stat-label">نزدیک‌ترین موعد</div><div id="kpiNext" class="stat-value">—</div></div>
          </div>
        </div>
      </div>

      <div class="card" id="board">
        <div class="card-header"><div class="card-title"><div class="card-icon">📝</div><span>تکالیف من</span></div></div>
        <div class="card-body">
          <div class="tasks-header" style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <div style="flex:1;min-width:180px"><input id="searchBox" class="form-control" placeholder="جستجو در تکالیف..."></div>
            <div class="filters" style="display:flex;gap:8px;align-items:center">
              <select id="filterSubject" class="filter-select"><option value="">همه درس‌ها</option></select>
              <select id="filterStatus" class="filter-select"><option value="">همه وضعیت‌ها</option><option value="open">باز</option><option value="done">انجام‌شده</option><option value="overdue">عقب‌افتاده</option></select>
              <select id="sortBy" class="filter-select"><option value="dueAsc">نزدیک‌ترین موعد</option><option value="dueDesc">دورترین موعد</option><option value="prio">اولویت</option><option value="created">تاریخ ایجاد</option></select>
            </div>
          </div>

          <div id="tasksList" class="tasks-list"></div>
          <div id="emptyState" class="empty-state" style="display:none;text-align:center;padding:30px;opacity:.8"> <div class="empty-icon">📭</div><h3>هنوز تکلیفی ثبت نشده</h3><p>از فرم سمت چپ اضافه کن ✍️</p></div>
        </div>
      </div>
    </div>

    <div class="footer">ساخته‌شده با ❤️ برای دانش‌آموزان — نسخهٔ آزمایشی محلی (داده‌ها در مرورگر شما ذخیره می‌شود)</div>
  </main>

  <div class="notification" id="notification" style="right:20px;left:auto;bottom:20px;position:fixed;display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:10px;background:var(--dark-card);color:var(--text-light);transform:translateY(100px);opacity:0;transition:var(--transition);z-index:2000">
    <span class="notification-icon">✓</span>
    <span class="notification-message">پیغام</span>
    <button class="notification-close" style="margin-inline-start:auto;background:none;border:none;color:inherit;font-size:18px;cursor:pointer">×</button>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // keep $ as jQuery — we will use it throughout
    // small vanilla helpers (don't override $)
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // storage
    const storeKey = 'mashqyar:v1';
    const remindersKey = 'mashqyar.reminders.v1';

    function uid(){ return 'id_'+Math.random().toString(36).slice(2,10); }
    function loadData(){ try{ const raw = localStorage.getItem(storeKey); if(!raw) return {subjects:[],tasks:[]}; const d = JSON.parse(raw); d.subjects = d.subjects||[]; d.tasks = d.tasks||[]; return d;}catch(e){console.error(e); return {subjects:[],tasks:[]}; }}
    function saveData(d){ localStorage.setItem(storeKey, JSON.stringify(d)); }

    function showNotification(msg, duration=2500){ const n = $('#notification'); $('.notification-message').text(msg); n.addClass('show'); n.css({transform:'translateY(0)',opacity:1}); setTimeout(()=>{ n.removeClass('show'); n.css({transform:'translateY(100px)',opacity:0}); }, duration); }
    $('.notification-close').on('click', ()=>{ $('#notification').removeClass('show'); $('#notification').css({transform:'translateY(100px)',opacity:0}); });

    let state = loadData();

    // --- import existing options into state.subjects if empty
    function importSubjectsFromSelectIfNeeded(){
      if (state.subjects && state.subjects.length) return;
      const seen = new Map();
      $('#subject').find('option').each(function(){
        const opt = $(this);
        if (opt.prop('disabled')) return; // skip placeholder and disabled
        const name = opt.text().trim();
        if (!name) return;
        if (seen.has(name)) return;
        const color = opt.data('color') || '#4361ee';
        const id = uid();
        seen.set(name, { id, name, color });
        // replace option value with id so future selections yield id
        opt.val(id);
      });
      state.subjects = Array.from(seen.values());
      saveData(state);
    }

    // render badges & filter
    function renderSubjectsBadges(){ $('#subjectsBadges').empty(); state.subjects.forEach(s=>{
      const $span = $(`<span class="subject-badge" data-id="${s.id}"><span class="subject-color" style="background:${s.color}"></span><span class="subject-name">${s.name}</span><button class="del-subject" title="حذف درس" style="margin-inline-start:8px;border:none;background:transparent;color:inherit;cursor:pointer">✖</button></span>`);
      $('#subjectsBadges').append($span);
      $span.find('.del-subject').on('click', function(e){ e.stopPropagation(); if(!confirm('آیا می‌خواهید این درس و تمام تکالیف مربوطه حذف شود؟')) return; const id = s.id; state.tasks = state.tasks.filter(t=>t.subjectId!==id); state.subjects = state.subjects.filter(x=>x.id!==id); // also remove any <option> with this id
        $('#subject').find(`option[value="${id}"]`).remove(); updateSubjectFilter(); saveData(state); renderSubjectsBadges(); renderTasks(); showNotification('درس و تکالیف مرتبط حذف شد'); });
    }); }

    function updateSubjectFilter(){ const $f = $('#filterSubject'); $f.empty().append('<option value="">همه درس‌ها</option>'); state.subjects.forEach(s=>{ $f.append($('<option>').val(s.id).text(s.name)); }); }

    function updateSubjectSelectFromState(){
      // ensure select has options for all state.subjects (and remove duplicates)
      const $sel = $('#subject');
      // remove all non-placeholder options
      $sel.find('option').each(function(){ const opt=$(this); if (opt.prop('disabled')) return; opt.remove(); });
      // append current subjects grouped by nothing (simple list) — preserves order of state
      state.subjects.forEach(s=>{ $sel.append($('<option>').val(s.id).text(s.name).attr('data-color', s.color)); });
      // keep placeholder at top
      $sel.prepend($('<option disabled selected value="">یک درس را انتخاب کن…</option>'));
    }

    // --- tasks UI
    function toPersianDate(dt){ if(!dt) return '—'; try{ return new persianDate(new Date(dt)).format('YYYY/MM/DD'); }catch(e){return '—'} }
    function toPersianDateTime(dt){ if(!dt) return '—'; try{ return new persianDate(new Date(dt)).format('YYYY/MM/DD HH:mm'); }catch(e){return '—'} }

    function priorityBadge(p){ if(p==='high') return '<span class="task-badge priority-high">اولویت بالا</span>'; if(p==='low') return '<span class="task-badge priority-low">اولویت کم</span>'; return '<span class="task-badge">معمولی</span>'; }

    function renderKPIs(){ const tasks = state.tasks || []; $('#kpiOpen').text(tasks.filter(t=>!t.completed).length); $('#kpiDone').text(tasks.filter(t=>t.completed).length); const upcoming = tasks.filter(t=>!t.completed&&t.deadline).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline))[0]; $('#kpiNext').text(upcoming? toPersianDate(upcoming.deadline) : '—'); }

    function applyFilters(tasks){ let out = tasks.slice(); const q = $('#searchBox').val().trim().toLowerCase(); const subj = $('#filterSubject').val(); const status = $('#filterStatus').val(); if(q) out = out.filter(t => (t.title+' '+(t.notes||'')+' '+(t.members||'')).toLowerCase().includes(q)); if(subj) out = out.filter(t=>t.subjectId===subj); const now = Date.now(); if(status==='open') out=out.filter(t=>!t.completed); if(status==='done') out=out.filter(t=>t.completed); if(status==='overdue') out=out.filter(t=>!t.completed && t.deadline && new Date(t.deadline).getTime()<now); const sortBy = $('#sortBy').val(); if(sortBy==='dueAsc') out.sort((a,b)=> (new Date(a.deadline||'2100-01-01')-new Date(b.deadline||'2100-01-01'))); if(sortBy==='dueDesc') out.sort((a,b)=> (new Date(b.deadline||'1970-01-01')-new Date(a.deadline||'1970-01-01'))); if(sortBy==='prio'){ const rank={high:0,normal:1,low:2}; out.sort((a,b)=> (rank[a.priority||'normal']-rank[b.priority||'normal']) || (new Date(a.deadline||'2100-01-01')-new Date(b.deadline||'2100-01-01'))); } if(sortBy==='created') out.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)); return out; }

    function subjectById(id){ return state.subjects.find(s=>s.id===id); }

    function renderTasks(){ const $container = $('#tasksList'); const tasks = applyFilters(state.tasks || []); renderKPIs(); $container.empty(); if(!tasks.length){ $('#emptyState').show(); return; } $('#emptyState').hide(); tasks.forEach(t=>{ const s = subjectById(t.subjectId); const deadline = t.deadline? new Date(t.deadline) : null; const overdue = !t.completed && deadline && deadline.getTime() < Date.now(); const $div = $('<div>').addClass('task-item' + (overdue? ' overdue':'')); const $content = $('<div>').addClass('task-content'); const $title = $('<h3>').text(t.title); $content.append($title); const $meta = $('<div>').addClass('task-meta'); if(s){ $meta.append($(`<span class="task-badge"><span class="subject-color" style="background:${s.color}"></span>${s.name}</span>`)); } if(t.deadline){ $meta.append($('<span>').addClass('task-badge').text('مهلت: '+ toPersianDateTime(t.deadline))); } $meta.append($(priorityBadge(t.priority||'normal'))); if(t.members){ $meta.append($('<span>').addClass('task-badge').text('اعضا: '+t.members)); } $content.append($meta); if(t.notes){ $content.append($('<div>').addClass('task-description').text(t.notes)); } const $actions = $('<div>').addClass('task-actions'); const $done = $('<button>').addClass('task-btn complete').html(t.completed? '↩️' : '✓').attr('title', t.completed? 'برگردان به باز' : 'انجام شد').on('click', ()=>{ t.completed = !t.completed; saveData(state); renderTasks(); showNotification(t.completed? 'تکلیف انجام شد' : 'تکلیف به حالت باز بازگشت',2000); }); const $edit = $('<button>').addClass('task-btn').html('✏️').attr('title','ویرایش').on('click', ()=> editTask(t.id)); const $del = $('<button>').addClass('task-btn').html('🗑️').attr('title','حذف').on('click', ()=>{ if(confirm('این تکلیف حذف شود؟')){ state.tasks = state.tasks.filter(x=>x.id!==t.id); saveData(state); renderTasks(); showNotification('تکلیف حذف شد',2000); } }); $actions.append($done,$edit,$del); $div.append($content,$actions); $container.append($div); }); }

    // --- editTask
    function editTask(id){ const t = state.tasks.find(x=>x.id===id); if(!t) return; const subj = subjectById(t.subjectId); if(subj){ $('#subject').val(subj.id); } if(t.deadline){ $('#deadline-enabled').prop('checked', true); $('#deadline-fields').show(); const date = new persianDate(new Date(t.deadline)); $('#deadline-date').val(date.format('YYYY/MM/DD')); const time = new Date(t.deadline); $('#deadline-time').val(time.toTimeString().slice(0,5)); } else { $('#deadline-enabled').prop('checked', false); $('#deadline-fields').hide(); } $('#taskPriority').val(t.priority||'normal'); $('#taskStatus').val(t.completed? 'done' : 'open'); $('#taskMembers').val(t.members||''); if(t.remindMinutes || t.notes){ $('#optional-box').prop('open', true); $('#reminder').val(t.remindMinutes||''); $('#notes').val(t.notes||''); } $('#addTaskBtn').text('ذخیره تغییرات').data('editId', id); window.scrollTo({top:0,behavior:'smooth'}); }

    // --- update filters
    function updateSubjectFilter(){ const $f = $('#filterSubject'); $f.empty().append('<option value="">همه درس‌ها</option>'); state.subjects.forEach(s=>{ $f.append($('<option>').val(s.id).text(s.name)); }); }

    // --- initial import & seed
    importSubjectsFromSelectIfNeeded(); updateSubjectFilter(); renderSubjectsBadges(); renderTasks(); updateSubjectSelectFromState(); // ensure #subject now uses ids as values

    // add-subject button
    $('#addSubjectBtn').on('click', function(){ const name = $('#newSubjectName').val().trim(); const color = $('#newSubjectColor').val() || '#4361ee'; if(!name){ showNotification('نام درس را وارد کنید',2000); return; } if(state.subjects.find(s=>s.name===name)){ showNotification('این درس قبلاً وجود دارد',2000); return; } const s = { id: uid(), name, color }; state.subjects.push(s); saveData(state); renderSubjectsBadges(); updateSubjectFilter(); updateSubjectSelectFromState(); $('#newSubjectName').val(''); showNotification('درس جدید اضافه شد',2000); });

    // toggle deadline fields
    function toggleDeadlineUI(){ const enabled = $('#deadline-enabled').is(':checked'); if(enabled) $('#deadline-fields').show(); else $('#deadline-fields').hide(); }
    $('#deadline-enabled').on('change', toggleDeadlineUI); toggleDeadlineUI();

    // bind filters
    ['#searchBox','#filterSubject','#filterStatus','#sortBy'].forEach(sel=>{ $(sel).on('input change', renderTasks); });

    // form submit (with scheduling reminders)
    $('#task-form').on('submit', function(e){ e.preventDefault(); const title = $('#title').val().trim(); const subjectId = $('#subject').val(); const subjectOption = $('#subject').find('option:selected'); const subjectColor = subjectOption.data('color') || '#4361ee'; // find or create subject
      let subject = state.subjects.find(s=>s.id===subjectId);
      if(!subject && $('#subject').val()){ // maybe option existed but not in state (rare)
        // create
        subject = { id: subjectId || uid(), name: subjectOption.text().trim(), color: subjectColor };
        state.subjects.push(subject);
        saveData(state); renderSubjectsBadges(); updateSubjectFilter(); updateSubjectSelectFromState();
      }
      let deadline = null; if($('#deadline-enabled').is(':checked')){ const dateStr = $('#deadline-date').val(); const timeStr = $('#deadline-time').val(); if(dateStr){ const pd = new persianDate(dateStr); const gDate = pd.toCalendar('gregorian').toDate(); if(timeStr){ const parts = timeStr.split(':'); gDate.setHours(parseInt(parts[0]||0,10), parseInt(parts[1]||0,10), 0,0); } deadline = gDate.toISOString(); } }
      const priority = $('#taskPriority').val() || 'normal'; const status = $('#taskStatus').val()==='done'; const members = $('#taskMembers').val().trim(); const remindMinutes = parseInt($('#reminder').val()||'0',10) || 0; const notes = $('#notes').val().trim(); if(!title){ showNotification('عنوان تکلیف را وارد کنید',2000); return; } if(!subject){ showNotification('درس را انتخاب کنید',2000); return; }
      const editId = $('#addTaskBtn').data('editId'); if(editId){ const t = state.tasks.find(x=>x.id===editId); if(t){ t.title = title; t.subjectId = subject.id; t.deadline = deadline; t.priority = priority; t.completed = status; t.members = members; t.remindMinutes = remindMinutes; t.notes = notes; } $('#addTaskBtn').text('ثبت تکلیف').removeData('editId'); showNotification('تکلیف با موفقیت ویرایش شد',2000); // update reminders: remove any existing reminder for this id
        const rems = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const idx = rems.findIndex(r=>r.id===editId); if(idx>-1) rems.splice(idx,1); localStorage.setItem(remindersKey, JSON.stringify(rems));
        // schedule new reminder if needed below
      } else {
        const newId = uid(); state.tasks.push({ id:newId, title, subjectId:subject.id, deadline, priority, completed:status, members, remindMinutes, notes, createdAt: new Date().toISOString() }); // schedule reminder using newId
        if(remindMinutes>0 && deadline){ scheduleReminder({ id: newId, title, subject: subject.name, deadlineTs: new Date(deadline).getTime(), reminderMin: remindMinutes }); }
        showNotification('تکلیف با موفقیت ثبت شد',2000);
      }
      // if editing and reminder requested, schedule
      if(editId){ if(remindMinutes>0 && deadline){ scheduleReminder({ id: editId, title, subject: subject.name, deadlineTs: new Date(deadline).getTime(), reminderMin: remindMinutes }); } }
      saveData(state); this.reset(); $('#deadline-fields').hide(); $('#optional-box').prop('open', false); updateSubjectFilter(); renderSubjectsBadges(); renderTasks(); });

    // clear all
    $('#clearBtn').on('click', function(){ if(confirm('کل داده‌های محلی حذف شود؟')){ localStorage.removeItem(storeKey); localStorage.removeItem(remindersKey); state = { subjects: [], tasks: [] }; // re-import options from original select DOM (if any)
        importSubjectsFromSelectIfNeeded(); updateSubjectFilter(); renderSubjectsBadges(); renderTasks(); showNotification('تمام داده‌ها حذف شد',2000); } });

    // export PNG
    $('#btn-export').on('click', async function(){ try{ const canvas = await html2canvas(document.getElementById('board'), { useCORS:true, scale:2 }); const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = 'mashqyar.png'; document.body.appendChild(a); a.click(); a.remove(); showNotification('خروجی PNG با موفقیت ایجاد شد',2000); }catch(e){ console.error(e); showNotification('خطا در ایجاد خروجی PNG',2000); } });

    // persian datepicker init
    $('#deadline-date').persianDatepicker({ initialValue:false, format:'YYYY/MM/DD', autoClose:true });

    // ===== reminders scheduling & rebuild =====
    function scheduleReminder({id, title, subject, deadlineTs, reminderMin}){
      if(!deadlineTs || !reminderMin || reminderMin<=0) return;
      const fireAt = deadlineTs - reminderMin*60*1000;
      if(isNaN(fireAt) || fireAt <= Date.now()) return;
      const list = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const exists = list.find(x=>x.id===id);
      const payload = { id, title, subject, fireAt, shown:false };
      if(!exists) list.push(payload); else Object.assign(exists, payload);
      localStorage.setItem(remindersKey, JSON.stringify(list));
      const delay = fireAt - Date.now(); setTimeout(()=> showReminder(id,title,subject), delay);
    }
    function showReminder(id,title,subject){ try{ new Notification('یادآوری تکلیف', { body: subject? `${title} — ${subject}`:title }); }catch(e){} const list = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const it = list.find(x=>x.id===id); if(it){ it.shown = true; localStorage.setItem(remindersKey, JSON.stringify(list)); } }
    window.__mashqyar__showReminder = showReminder;

    async function ensurePermission(){ if(!('Notification' in window)) return false; if(Notification.permission==='granted') return true; if(Notification.permission==='denied') return false; const p = await Notification.requestPermission(); return p==='granted'; }

    // When form submit schedules reminders for new tasks (see submit handler). Also rebuild on load:
    (function rebuildReminders(){ if(!('Notification' in window)) return; const list = JSON.parse(localStorage.getItem(remindersKey)||'[]'); list.forEach(it=>{ if(it.shown) return; const delay = it.fireAt - Date.now(); if(delay<=0){ try{ new Notification('یادآوری تکلیف', { body: it.subject? `${it.title} — ${it.subject}`:it.title }); }catch(e){} it.shown = true; } else { setTimeout(()=>{ try{ new Notification('یادآوری تکلیف', { body: it.subject? `${it.title} — ${it.subject}`:it.title }); }catch(e){} it.shown = true; const cur = JSON.parse(localStorage.getItem(remindersKey)||'[]'); const me = cur.find(x=>x.id===it.id); if(me) me.shown = true; localStorage.setItem(remindersKey, JSON.stringify(cur)); }, delay); } }); localStorage.setItem(remindersKey, JSON.stringify(list)); })();

    // When page loads, if no subjects in state, import from select (already called above) and if tasks empty create sample tasks using subjects (optional)
    if((!state.subjects || state.subjects.length===0) && $('#subject').find('option').length>1){ importSubjectsFromSelectIfNeeded(); updateSubjectFilter(); renderSubjectsBadges(); updateSubjectSelectFromState(); saveData(state); }
    if(!state.tasks || state.tasks.length===0){ // optional sample tasks — keep or remove as you like
      if(state.subjects && state.subjects.length>=2){ const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1); const dayAfter = new Date(); dayAfter.setDate(dayAfter.getDate()+2); state.tasks = [ { id: uid(), title: 'حل تمرین 1 تا 10', subjectId: state.subjects[0].id, deadline: tomorrow.toISOString(), remindMinutes: 120, priority: 'high', members:'', notes:'دفتر حل لازم است', completed:false, createdAt:new Date().toISOString() }, { id: uid(), title: 'خلاصه‌نویسی فصل گیاهان', subjectId: state.subjects[1].id, deadline: dayAfter.toISOString(), remindMinutes: 60, priority: 'normal', members:'علی، زهرا', notes:'با تصاویر', completed:false, createdAt:new Date().toISOString() } ]; saveData(state); renderTasks(); }
    }

  </script>
</body>
</html>
